#packages:
#  audio: !include services/esp32-s3-box-3.yaml   #ha語音助手

esphome:
  name: esp32-tft-display
  friendly_name: esp32-tft-display
#   platformio_options:
#     build_flags: "-DBOARD_HAS_PSRAM"
#     board_build.arduino.memory_type: qio_opi
esp32:
  board: esp32s3box
  flash_size: 16MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"

# Enable logging
logger:

# Enable Home Assistant API
api:

ota:
  - platform: esphome

wifi:
  networks:
  - ssid: "YiFan WIFI"
    password: "1234567890"
  - ssid: "kmlon-3"
    password: "0912561063"

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Esp32-Tft-Display"
    password: "1234567890"

captive_portal:

pca9554:
  - id: pca9557_io
    address: 0x19 # 設定PCA9557的I2C位址

output:
    # Backlight LED
  - platform: ledc
    pin: GPIO42
    id: led_back_light
    inverted: true
    frequency: 1000Hz

  - platform: gpio
    id: lcd_cs
    pin:
      pca9554: pca9557_io
      number: 0 # 對應PCA9557的IO1
      mode: output
      inverted: false

#  - platform: gpio
#    id: paen
#    pin:
#      pca9554: pca9557_io
#      number: 1 # 對應PCA9557的IO1
#      mode: output
#      inverted: true   
light:
  - platform: monochromatic
    output: led_back_light
    name: Backlight
    id: backlight
    restore_mode: ALWAYS_ON

globals:
  - id: backlight_dimmed
    type: bool
    restore_value: no
    initial_value: 'false'

i2c:
  scl: GPIO2
  sda: GPIO1
  scan: true

spi:
- id: tft_spi
  clk_pin: GPIO41
  mosi_pin: GPIO40
  # miso_pin: 5 
#- id: touch_spi
#  clk_pin: 25
#  mosi_pin: 32
#  miso_pin: 35

display:
  - platform: ili9xxx
    id: my_display
    model: st7789v
    spi_id: tft_spi
    dc_pin: GPIO39
  #  cs_pin: 4
  #  reset_pin: 15
    invert_colors: true
    show_test_card: false
    update_interval: never
    auto_clear_enabled: false
    rotation: 90
    # transform:
    #   swap_xy: false
    #   mirror_x: true
    dimensions:
      height: 320
      width: 240

touchscreen:
  platform: ft63x6
  id: tft_touchscreen
#  spi_id: touch_spi
#  cs_pin: 33
#  interrupt_pin: 34
  calibration:
    x_min: 0
    x_max: 320
    y_min: 0
    y_max: 240
  transform:
#    mirror_x: true
    mirror_y: true
    swap_xy: true
#  on_touch:
#    - lambda: |-
#          ESP_LOGI("cal", "x=%d, y=%d, x_raw=%d, y_raw=%0d",
#              touch.x,
#              touch.y,
#              touch.x_raw,
#              touch.y_raw
#              );
  on_touch:
    - if:
        condition:
          lambda: 'return id(backlight_dimmed);'
        then:
          - light.turn_on:
              id: backlight
              brightness: 100%   # 恢復亮度
          - lambda: |-
              id(backlight_dimmed) = false;
          - lvgl.resume:   # 若之前有 lvgl.pause，可解除暫停刷新
          - logger.log: "螢幕被喚醒，亮度恢復 100%"    

bluetooth_proxy:

esp32_ble_tracker:

font:
  - file:
      type: gfonts
      family: Noto Sans TC
    id: font_cn_20
    size: 20
    glyphs: [ 
          "玄關","客廳","主燈","大門","上解鎖",
          ]
  - file: 'fonts/materialdesignicons-webfont.ttf'
    id: font_icon_26
    size: 26
    glyphs: [
      "\U000f06e9", # light
      "\U000f033e", # lock
    ]

text_sensor:
  - platform: homeassistant
    id: lock_state_raw
    entity_id: lock.lock_77a6
    on_value:
      then:
        - if:
            condition:
              lambda: 'return id(lock_state_raw).state == "locked";'
            then:
              - lvgl.widget.update:
                  id: lv_button_lock
                  state:
                    checked: true
              - lvgl.widget.update:
                  id: lv_button_unlock
                  state:
                    checked: false
        - if:
            condition:
              lambda: 'return id(lock_state_raw).state == "unlocked";'
            then:
              - lvgl.widget.update:
                  id: lv_button_lock
                  state:
                    checked: false
              - lvgl.widget.update:
                  id: lv_button_unlock
                  state:
                    checked: true
        - if:
            condition:
              and:
                - lambda: 'return id(lock_state_raw).state != "locked";'
                - lambda: 'return id(lock_state_raw).state != "unlocked";'
            then:
              - lvgl.widget.update:
                  id: lv_button_lock
                  state:
                    checked: true
              - lvgl.widget.update:
                  id: lv_button_unlock
                  state:
                    checked: true

binary_sensor:
  - platform: homeassistant
    id: main_light
    entity_id: light.yeelink_sg_442933452_ceiling22_s_2_light #客廳主燈
    publish_initial_state: true
    on_state:
      then:
        lvgl.widget.update:
          id: lv_button_main_light
          state:
            checked: !lambda return x;

  - platform: homeassistant
    id: sub_light
    entity_id: light.xuan_guan_deng #玄關燈
    publish_initial_state: true
    on_state:
      then:
        lvgl.widget.update:
          id: lv_button_sub_light
          state:
            checked: !lambda return x;   
  
#  - platform: homeassistant
#    id: lock_button
#    entity_id: lock.lock_77a6 #上鎖
#    # publish_initial_state: true
#    on_state:
#      then:
#        lvgl.widget.update:
#          id: lv_button_lock
#          state:
#            checked: !lambda return x; 

#  - platform: homeassistant
#    id: unlock_button
#    entity_id: lock.lock_77a6 #解鎖
#    # publish_initial_state: true
#    on_state:
#      then:
#        lvgl.widget.update:
#          id: lv_button_unlock
#          - lambda: |-
#            if (x == "unlocked") {
#            return "on";
#            }

lvgl:
  buffer_size: 25%
  color_depth: 16
  bg_color: black
  border_width: 0
  outline_width: 0
  shadow_width: 0
  default_font: font_cn_20
  displays:
    - my_display
  touchscreens:
    - tft_touchscreen
  theme:
    button:
      text_font: font_cn_20
      scroll_on_focus: true
      # group: general
      radius: 15
      width: 85
      height: 85
      pad_left: 10px
      pad_top: 10px
      pad_bottom: 10px
      pad_right: 10px
      shadow_width: 0
      bg_color: 0x313131
      text_color: 0xd9d9d9
      checked:
        bg_color: 0xCC5E14
        text_color: 0xFFA500
  on_idle:
    timeout: 30000ms   # 閒置 30 秒
    then:
      - if:
          condition:
            lambda: 'return !id(backlight_dimmed);'
          then:
            - light.turn_on:
                id: backlight
                brightness: 30%   # 降亮
            - lambda: |-
                id(backlight_dimmed) = true;
            - logger.log: "螢幕閒置 30 秒，亮度降至 30%"  # on_idle:
            - lvgl.pause:
  #   - timeout: 10s
  #     then:
  #       - logger.log: idle timeout
  #       - if:
  #           condition:
  #             lvgl.is_idle:
  #               timeout: 5s
  #           then:
  #             - logger.log: LVGL is idle
  #   - timeout: 15s
  #     then:
  #       - logger.log: idle 15s timeout
  #       - lvgl.pause:
  #       - light.turn_off:
  #           id: backlight
  #           transition_length: 3s
  # on_resume:
  #   then: 
  #     - light.turn_on:
  #         id: backlight
  #         transition_length: 1s

  page_wrap: true
############################################################################上下導引(時間，連線狀態等，回首頁，開關螢幕)##########################################################################################
################################################################主頁#鎖上大門#解鎖大門#關閉所有燈#各房間入口(客廳 主臥 臥室 書房等)##############################################################################
  pages:
##############################################################################################範例##########################################################################################################
    - id: main_page
      widgets:
        - obj:
            align: TOP_LEFT
            width: 310
            height: 230
            x: 10
            y: 10
            # pad_all: 3
            bg_opa: TRANSP
            border_opa: TRANSP  #cover #TRANSP
            layout:
              type: flex
              flex_flow: column_wrap
              # flex_align_cross: CENTER # they sould be centered
            bg_color: 0x000000
            # bg_opa: cover
            pad_all: 2
            widgets:
#############################################################################################左上########################################################################################################
              - button:
                  height: 100
                  width: 140
                  checkable: true
                  id: lv_button_main_light
                  widgets:
                    - label:
                        text_font: font_icon_26
                        align: top_left
                        text: "\U000f06e9"    #light
                        id: lv_button_main_light_icon
                    - label:
                        text_font: font_cn_20
                        align: bottom_right
                        text: "客廳主燈"
                        long_mode: dot
                  on_click:
                  - homeassistant.action:
                      action: light.toggle
                      data:
                        entity_id: light.yeelink_sg_442933452_ceiling22_s_2_light
#############################################################################################左下########################################################################################################
              - button:
                  height: 100
                  width: 140
                  checkable: true
                  id: lv_button_sub_light
                  widgets:
                    - label:
                        text_font: font_icon_26
                        align: top_left
                        text: "\U000f06e9"    #light
                        id: lv_button_sub_light_icon
                    - label:
                        text_font: font_cn_20
                        align: bottom_right
                        text: "玄關燈"
                        long_mode: dot
                  on_click:
                  - homeassistant.action:
                      action: light.toggle
                      data:
                        entity_id: light.xuan_guan_deng
#############################################################################################右上########################################################################################################
              - button:
                  height: 100
                  width: 140
                  checkable: true
                  id: lv_button_lock
                  widgets:
                    - label:
                        text_font: font_icon_26
                        align: top_left
                        text: "\U000f033e"    #lock
                        id: lv_button_lock_icon
                    - label:
                        text_font: font_cn_20
                        align: bottom_right
                        text: "大門上鎖"
                        long_mode: dot
                  on_click:
                  - homeassistant.action:
                      action: lock.lock
                      data:
                        entity_id: lock.lock_77a6
#############################################################################################右下########################################################################################################
              - button:
                  height: 100
                  width: 140
                  checkable: true
                  id: lv_button_unlock
                  widgets:
                    - label:
                        text_font: font_icon_26
                        align: top_left
                        text: "\U000f033e"     #lock
                        id: lv_button_unlock_icon
                    - label:
                        text_font: font_cn_20
                        align: bottom_right
                        text: "大門解鎖"
                        long_mode: dot
                  on_click:
                    - homeassistant.action:
                        action: lock.unlock
                        data:
                          entity_id: lock.lock_77a6
######################################################################################客廳################################################################################################
######################################################################################主臥################################################################################################   
######################################################################################臥室################################################################################################
######################################################################################書房################################################################################################  
######################################################################################其他################################################################################################
